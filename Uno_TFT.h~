/*
Control lines are all on PORTC, and data lines are on PORTB and PORTD.

Communication is faster if we write to PORTC directly. There is one unused
GPIO pin that will be clobbered in this operation, so projects using this
pin should plan accordingly. The reset line is also on PORTC so care must
be taken not to trigger it. 

On the 9341, the 8-bit data bus is split with the top six bits on PORTB
and the lower two bits on PORTD. The lower two bits on PORTB are digital 
pins 0 and 1, used for the RX and TX serial lines. As far as I can tell, 
when the UART is enabled on the AtMega, these pins are decoupled from 
PORTB, or at least I have found that setting these pins in the display
driver does not seem to interfere with serial communication. Likewise, 
upper bits on PORTD are used to communicate with the touch screen and SD
card slot and for whatever reason sending spurious data on these lines does
not seem to interfere with these functions. If interference is observed,
simply set critical pins to input mode (high impedence) while running
display driver code. Because of this lack of interference, we can send 
data using the succinct PORTB=PORTD=data.

Bits are as follows on PORTC (there is no PC7 on AtMega*8)
PC6: Reset (keep high)
PC5: Not used,  set to 1 by TFT control code
PC4: RESET LINE keep high
PC3: CS line keep low while driving, leave high to disable interface
PC2: Data send bit. 1 for sending data, 0 for sending command
PC1: Write clock bit. Triggered on rising edge, I think. 
PC0: Chip select line. 1 for enabel. Left high by driver code. 

#define READY_COMMAND     PORTC=0b1110001
#define SEND_COMMAND      PORTC=0b1110011
#define READY_DATA        PORTC=0b1110101
#define SEND_DATA         PORTC=0b1110111
#define READY_READ        PORTC=0b1110110
#define REQUEST_READ      PORTC=0b1110010
*/

#define RS_PIN 4
#define CS_PIN 3
#define CD_PIN 2
#define WR_PIN 1
#define RD_PIN 0
#define CONTROLPORT PORTC

#define FRAME_ID_BIT 3
#define QUICK_READ_MASK   0b11111100

#define READ_BYTE ((PIND&B11111100)|(PINB&B00000011))

//////////////////////////////////////////////////////////////////////////
// Formerly pin_magic.h

#define WRITE_BUS(b) {\
    PORTB=PORTD=(b);\
}

#define WRITE_BUS_FAST(b) {\
    PORTD=(b);\
}

#define setWriteDir() {\
    DDRD |=  B11111100;\
    DDRB |=  B00000011;\
}

#define setReadDir()  {\
    DDRD &= ~B11111100;\
    DDRB &= ~B00000011;\
}

//////////////////////////////////////////////////////////////////////////
// Color reading and writing

#define QUICK_READ PIND

//////////////////////////////////////////////////////////////////////////
// Permutations between color bit order and port bit order.
// In the Leonardo these are complex, and are computed ahead of time
// to speed up IO.
// On the Uno, these permutations can be replaced by the identity map.

// Send color data from 565 format into the permuted representation
// for faster IO
#define BIT_TO_PORT_PERMUTATION(b) (\
    ((((b)>>0)&1)<<2)|\
    ((((b)>>1)&1)<<3)|\
    ((((b)>>2)&1)<<1)|\
    ((((b)>>3)&1)<<0)|\
    ((((b)>>4)&1)<<4)|\
    ((((b)>>5)&1)<<5)|\
    ((((b)>>6)&1)<<7)|\
    ((((b)>>7)&1)<<6)\
)

// Take color data form port permutation back to the color 565 bit order
#define PORT_TO_BIT_PERMUTATION(b) (\
    ((((b)>>2)&1)<<0)|\
    ((((b)>>3)&1)<<1)|\
    ((((b)>>1)&1)<<2)|\
    ((((b)>>0)&1)<<3)|\
    ((((b)>>4)&1)<<4)|\
    ((((b)>>5)&1)<<5)|\
    ((((b)>>7)&1)<<6)|\
    ((((b)>>6)&1)<<7)\
)

#define WRITE_PERMUTED_BUS(d) {\
    PORTE = (d) & B01000000;\
    PORTD = (d) & B10010011;\
    PORTB = ((d)<<2) & B00110000;\
    PORTC = ((d)<<1) & B01000000;\
}

// This is a sanity check
#define IDENTITY(b) BIT_TO_PORT_PERMUTATION(PORT_TO_BIT_PERMUTATION(b))

#define PERMUTED_QUICK_READ (\
    (PIND & 0b10010011)\
  | (PINE & 0b01000000)\
  |((PINB & 0b00110000)>>2)\
)

// This needs to grab at least the mask aka frame_ID bit and should
// also grab whatever bits we want to use to recognize background vs.
// foreground colors. Frame bit is on D
#define QUICK_READ (\
    ((PINE&B01000000|PIND&B00000010) << 1) |       \
    ((PIND&B10000000) >> 1) |       \
    ((PIND&B00000001) << 3) | \
     (PIND&B00010000)\
)


